<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Darts Party</title>
    <link rel="icon" type="image/png" href="icon.png">
    <!-- Tailwind Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Shared CSS -->
    <link rel="stylesheet" href="shared.css">
</head>

<body
    class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-slate-900 dark:via-purple-950 dark:to-slate-900 min-h-screen transition-colors duration-300">
    
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="p-4 flex justify-between items-center max-w-4xl mx-auto w-full relative z-10">
            <div class="flex items-center gap-2">
                <a href="index.html" class="p-2 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700 transition-colors text-gray-700 dark:text-gray-200">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </a>
                <h1
                    class="text-xl font-black bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-400 dark:to-pink-400">
                    DARTS PARTY</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()"
                    class="p-3 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700 transition-colors text-gray-700 dark:text-gray-200"
                    aria-label="Toggle theme">
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                </button>
                <button onclick="toggleSound()"
                    class="p-3 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700 transition-colors text-gray-700 dark:text-gray-200"
                    aria-label="Toggle sound">
                    <i data-lucide="volume-2" id="sound-on-icon" class="w-5 h-5 hidden"></i>
                    <i data-lucide="volume-x" id="sound-off-icon" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-4xl mx-auto pb-8 w-full flex-1 relative z-0">
            <div class="max-w-md mx-auto">
                <div class="flex-1 bg-gray-50 dark:bg-slate-500 px-4 py-2 rounded-xl">
                    <div class="flex justify-center items-center gap-3 animate-scale-in">
                        <div onclick="switchType(true)" class="flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white cursor-pointer" id="player-tab">
                            Player
                        </div>
                        <div onclick="switchType(false)" class="flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white cursor-pointer" id="team-tab">
                            Team
                        </div>
                    </div>
                </div>
                <div id="player-setup" class="pt-8 px-4 animate-slide-in-right">
                    <!-- Content will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <script src="shared.js"></script>
    <script>
        let gameMode = '501';
        let isPlayerType = true;

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return params.get('mode') || '501';
        }

        function switchType(playerType) {
            console.log('switchType', playerType);
            isPlayerType = playerType;
            const state = getState();
            state.isPlayerType = isPlayerType;
            saveState(state);
            db.saveParticipants();
            renderSetup();
        }

        function renderSetup() {
            const state = getState();
            console.log(state)
            const container = document.getElementById('player-setup');
            const playerTab = document.getElementById('player-tab');
            const teamTab = document.getElementById('team-tab');
            
            isPlayerType = state.isPlayerType === undefined ? true : state.isPlayerType;
            
            // Update tabs
            if (playerTab && teamTab) {
                playerTab.className = `flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white ${isPlayerType ? 'bg-red-500 dark:bg-red-500 cursor-default' : 'cursor-pointer'}`;
                teamTab.className = `flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white ${isPlayerType ? 'cursor-pointer' : 'bg-green-500 dark:bg-green-500 cursor-default'}`;
            }

            if (isPlayerType) {
                container.innerHTML = `
                    <div class="animate-slide-in-right">
                        <div class="max-w-md mx-auto">
                            <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl p-6 mb-6 transition-colors duration-300">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">Players</h3>
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">${state.players.filter(p => p.active !== false).length}/${state.players.length} active</span>
                                </div>
                                <div id="player-inputs" class="space-y-3">
                                    ${state.players.map(p => `
                                        <div class="flex items-center gap-3 animate-fade-in ${p.active !== false ? '' : 'opacity-50'}">
                                            <input type="checkbox" ${p.active !== false ? 'checked' : ''} onchange="togglePlayerActive('${p.id}', this.checked)" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500 cursor-pointer flex-shrink-0">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm flex-shrink-0" style="background-color: ${p.color}">
                                                <i data-lucide="user" class="w-5 h-5"></i>
                                            </div>
                                            <input type="text" value="${p.name}" oninput="updatePlayerName('${p.id}', this.value)" class="flex-1 w-1 bg-gray-50 dark:bg-slate-700 border-2 border-transparent focus:border-purple-500 dark:focus:border-purple-400 rounded-xl px-4 py-2 outline-none font-medium text-gray-800 dark:text-white transition-colors" placeholder="Player Name">
                                            ${state.players.length > 1 ? `<button onclick="removePlayer('${p.id}')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick="addPlayer()" ${state.players.length >= 20 ? 'disabled' : ''} class="w-full mt-4 py-3 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-xl text-gray-500 dark:text-gray-400 font-bold flex items-center justify-center gap-2 hover:border-purple-500 hover:text-purple-500 dark:hover:border-purple-400 dark:hover:text-purple-400 transition-colors disabled:opacity-50">
                                    <i data-lucide="plus" class="w-5 h-5"></i> Add Player
                                </button>
                            </div>
                            <button onclick="startGame()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-black text-xl shadow-lg shadow-purple-500/30 flex items-center justify-center gap-2 transition-all hover:scale-[1.02] active:scale-[0.98]">
                                <i data-lucide="play" class="w-6 h-6 fill-current"></i> START GAME
                            </button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="animate-slide-in-right">
                        <div class="max-w-md mx-auto">
                            <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl p-6 mb-4 transition-colors duration-300">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">Teams</h3>
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">${state.teams.length}/20</span>
                                </div>
                                <div id="team-inputs" class="space-y-3 mb-4">
                                    ${state.teams.map(t => `
                                        <div class="animate-fade-in">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm flex-shrink-0" style="background-color: ${t.color}">
                                                    <i data-lucide="users" class="w-5 h-5"></i>
                                                </div>
                                                <input type="text" value="${t.name}" oninput="updateTeamName('${t.id}', this.value)" class="flex-1 bg-gray-50 dark:bg-slate-700 border-2 border-transparent focus:border-purple-500 dark:focus:border-purple-400 rounded-xl px-4 py-2 outline-none font-medium text-gray-800 dark:text-white transition-colors" placeholder="Team Name">
                                                ${state.teams.length > 1 ? `<button onclick="removeTeam('${t.id}')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>` : ''}
                                            </div>
                                            <div class="ml-13 mb-2">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Players:</span>
                                                    <button onclick="assignPlayersToTeam('${t.id}', 'random')" class="text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">Random</button>
                                                    <button onclick="assignPlayersToTeam('${t.id}', 'manual')" class="text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">Manual</button>
                                                    <button onclick="clearTeamPlayers('${t.id}')" class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Clear</button>
                                                </div>
                                                <div id="team-${t.id}-players" class="flex flex-wrap gap-1.5 min-h-[24px]">
                                                    ${(t.players || []).map(pId => {
                                                        const player = state.players.find(pl => pl.id === pId);
                                                        return player ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 bg-gray-100 dark:bg-slate-700 rounded text-xs font-medium" style="color: ${player.color}">
                                                            ${player.name}
                                                            <button onclick="removePlayerFromTeam('${t.id}', '${pId}')" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>
                                                        </span>` : '';
                                                    }).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick="addTeam()" ${state.teams.length >= 20 ? 'disabled' : ''} class="w-full py-3 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-xl text-gray-500 dark:text-gray-400 font-bold flex items-center justify-center gap-2 hover:border-purple-500 hover:text-purple-500 dark:hover:border-purple-400 dark:hover:text-purple-400 transition-colors disabled:opacity-50">
                                    <i data-lucide="plus" class="w-5 h-5"></i> Add Team
                                </button>
                            </div>
                            ${gameMode === 'Highest Score' || gameMode === 'Lowest Score' ? `
                                <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Number of Rounds</label>
                                    <input type="number" id="rounds-input" value="10" min="1" max="50" class="w-full bg-gray-50 dark:bg-slate-700 border-2 border-transparent focus:border-purple-500 dark:focus:border-purple-400 rounded-xl px-4 py-2 outline-none font-medium text-gray-800 dark:text-white transition-colors">
                                </div>
                            ` : ''}
                            <button onclick="startGame()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-black text-xl shadow-lg shadow-purple-500/30 flex items-center justify-center gap-2 transition-all hover:scale-[1.02] active:scale-[0.98]">
                                <i data-lucide="play" class="w-6 h-6 fill-current"></i> START GAME
                            </button>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function addPlayer() {
            const state = getState();
            if (state.players.length >= 20) return;
            const id = Math.random().toString(36).substr(2, 9);
            const color = PLAYER_COLORS[state.players.length % PLAYER_COLORS.length];
            state.players.push({ id, name: `Player ${state.players.length + 1}`, score: 0, color, active: true });
            saveState(state);
            renderSetup();
        }

        function removePlayer(id) {
            const state = getState();
            if (state.players.length <= 1) return;
            state.players = state.players.filter(p => p.id !== id);
            saveState(state);
            renderSetup();
        }

        function togglePlayerActive(id, active) {
            const state = getState();
            const p = state.players.find(p => p.id === id);
            if (p) {
                p.active = active;
                saveState(state);
                db.saveParticipants();
                renderSetup();
                playSound('click');
            }
        }

        function deletePlayer(id) {
            const state = getState();
            state.players = state.players.filter(p => p.id !== id);
            saveState(state);
            db.saveParticipants();
            renderSetup();
            playSound('click');
            playSound('delete');
        }

        function updatePlayerName(id, name) {
            const state = getState();
            const p = state.players.find(p => p.id === id);
            if (p) {
                p.name = name;
                saveState(state);
                db.saveParticipants();
            }
        }

        function addTeam() {
            const state = getState();
            if (state.teams.length >= 20) return;
            const id = Math.random().toString(36).substr(2, 9);
            const color = TEAM_COLORS[state.teams.length % TEAM_COLORS.length];
            state.teams.push({ id, name: `Team ${state.teams.length + 1}`, score: 0, color, players: [] });
            saveState(state);
            db.saveParticipants();
            renderSetup();
        }

        function removeTeam(id) {
            const state = getState();
            if (state.teams.length <= 1) return;
            state.teams = state.teams.filter(t => t.id !== id);
            saveState(state);
            db.saveParticipants();
            renderSetup();
        }

        function updateTeamName(id, name) {
            const state = getState();
            const t = state.teams.find(t => t.id === id);
            if (t) {
                t.name = name;
                saveState(state);
                db.saveParticipants();
            }
        }

        function assignPlayersToTeam(teamId, method) {
            const state = getState();
            const team = state.teams.find(t => t.id === teamId);
            if (!team) return;

            if (method === 'random') {
                // Randomly assign all players to teams
                const allPlayerIds = state.players.map(p => p.id);
                const shuffled = [...allPlayerIds].sort(() => Math.random() - 0.5);
                const playersPerTeam = Math.ceil(shuffled.length / state.teams.length);
                const teamIndex = state.teams.findIndex(t => t.id === teamId);
                const startIndex = teamIndex * playersPerTeam;
                const endIndex = Math.min(startIndex + playersPerTeam, shuffled.length);
                team.players = shuffled.slice(startIndex, endIndex);
            } else if (method === 'manual') {
                // Show modal/dialog for manual selection
                showPlayerSelector(teamId);
                return;
            }
            
            saveState(state);
            db.saveParticipants();
            renderSetup();
        }

        function showPlayerSelector(teamId) {
            const state = getState();
            const team = state.teams.find(t => t.id === teamId);
            if (!team) return;

            // Create modal for player selection
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-3xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Select Players for ${team.name}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="space-y-2 mb-4">
                        ${state.players.map(p => {
                            const isSelected = (team.players || []).includes(p.id);
                            return `
                                <label class="flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="togglePlayerInTeam('${teamId}', '${p.id}', this.checked)" class="w-4 h-4 text-purple-600 rounded">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background-color: ${p.color}">${p.name.substring(0, 2).toUpperCase()}</div>
                                    <span class="font-medium text-gray-800 dark:text-white">${p.name}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="w-full py-2 bg-purple-600 text-white rounded-xl font-bold">Done</button>
                </div>
            `;
            document.body.appendChild(modal);
            if (window.lucide) window.lucide.createIcons();
        }

        function togglePlayerInTeam(teamId, playerId, add) {
            const state = getState();
            const team = state.teams.find(t => t.id === teamId);
            if (!team) return;

            if (!team.players) team.players = [];

            if (add) {
                if (!team.players.includes(playerId)) {
                    team.players.push(playerId);
                }
            } else {
                team.players = team.players.filter(id => id !== playerId);
            }

            saveState(state);
            db.saveParticipants();
            renderSetup();
        }

        function removePlayerFromTeam(teamId, playerId) {
            togglePlayerInTeam(teamId, playerId, false);
        }

        function clearTeamPlayers(teamId) {
            const state = getState();
            const team = state.teams.find(t => t.id === teamId);
            if (team) {
                team.players = [];
                saveState(state);
                db.saveParticipants();
                renderSetup();
            }
        }

        function startGame() {
            gameMode = getUrlParams();
            const state = getState();
            
            let participants;
            let teamMembers = {}; // Map teamId -> array of player objects
            
            if (state.isPlayerType) {
                // Only include active players
                participants = state.players.filter(p => p.active !== false);
                if (participants.length === 0) {
                    alert('Please select at least one active player to start the game!');
                    return;
                }
            } else {
                // For teams, create participant objects with team members
                participants = state.teams.map((team, i) => {
                    // Get actual player objects for this team
                    const teamPlayerObjects = (team.players || []).map(playerId => {
                        const player = state.players.find(p => p.id === playerId);
                        if (!player) return null;
                        return {
                            ...player,
                            score: gameMode === '501' ? 501 : gameMode === 'Killer' ? INITIAL_LIVES : 0,
                            cricketState: gameMode === 'Cricket' ? { 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 25: 0 } : undefined,
                            killerTarget: gameMode === 'Killer' ? i + 1 : undefined,
                            tttClaims: [],
                        };
                    }).filter(p => p !== null);
                    
                    teamMembers[team.id] = teamPlayerObjects;
                    
                    return {
                        ...team,
                        score: gameMode === '501' ? 501 : gameMode === 'Killer' ? INITIAL_LIVES : 0,
                        cricketState: gameMode === 'Cricket' ? { 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 25: 0 } : undefined,
                        killerTarget: gameMode === 'Killer' ? i + 1 : undefined,
                        tttClaims: [],
                        teamMembers: teamPlayerObjects, // Store team members
                        isTeam: true
                    };
                });
            }
            
            // Get rounds configuration for Highest Score and Lowest Score modes
            let totalRounds = 10; // Default
            if (gameMode === 'Highest Score' || gameMode === 'Lowest Score') {
                const roundsInput = document.getElementById('rounds-input');
                if (roundsInput) {
                    totalRounds = parseInt(roundsInput.value) || 10;
                }
            }
            
            // Initialize game state
            const gameState = {
                gameId: `game_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                gameMode: gameMode,
                activeParticipants: participants.map((p, i) => ({
                    ...p,
                    score: gameMode === '501' ? 501 : gameMode === 'Killer' ? INITIAL_LIVES : 0,
                    cricketState: gameMode === 'Cricket' ? { 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 25: 0 } : undefined,
                    killerTarget: gameMode === 'Killer' ? i + 1 : undefined,
                    tttClaims: [],
                    currentRound: (gameMode === 'Highest Score' || gameMode === 'Lowest Score') ? 1 : undefined,
                    totalRounds: (gameMode === 'Highest Score' || gameMode === 'Lowest Score') ? totalRounds : undefined,
                })),
                currentPlayerIndex: 0,
                currentTeamMemberIndex: 0, // For teams, track which member is throwing
                winner: null,
                history: [],
                roundThrows: [],
                throws: [],
                totalThrows: 0,
                isPlayerType: state.isPlayerType,
                teamMembers: teamMembers
            };
            
            saveGameState(gameState);
            state.gameMode = gameMode;
            saveState(state);
            window.location.href = 'game.html';
        }

        window.onload = async () => {
            updateTheme();
            updateSoundIcons();
            try {
                await db.init();
                await db.loadParticipants();
            } catch (e) {
                console.error('Failed to initialize DB', e);
            }
            renderSetup();
            lucide.createIcons();
        };
    </script>
</body>

</html>
