<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Darts Party</title>
    <link rel="icon" type="image/png" href="icon.png">
    <!-- Tailwind Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Shared CSS -->
    <link rel="stylesheet" href="shared.css">
</head>

<body
    class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-slate-900 dark:via-purple-950 dark:to-slate-900 min-h-screen transition-colors duration-300">
    
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="p-4 flex justify-between items-center max-w-4xl mx-auto w-full relative z-10">
            <div class="flex items-center gap-2">
                <a href="index.html" class="p-2 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700 transition-colors text-gray-700 dark:text-gray-200">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </a>
                <h1
                    class="text-xl font-black bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-400 dark:to-pink-400">
                    DARTS PARTY</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()"
                    class="p-3 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700 transition-colors text-gray-700 dark:text-gray-200"
                    aria-label="Toggle theme">
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                </button>
                <button onclick="toggleSound()"
                    class="p-3 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700 transition-colors text-gray-700 dark:text-gray-200"
                    aria-label="Toggle sound">
                    <i data-lucide="volume-2" id="sound-on-icon" class="w-5 h-5 hidden"></i>
                    <i data-lucide="volume-x" id="sound-off-icon" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-4xl mx-auto pb-8 w-full flex-1 relative z-0">
            <div class="max-w-md mx-auto">
                <div class="flex-1 bg-gray-50 dark:bg-slate-500 px-4 py-2 rounded-xl">
                    <div class="flex justify-center items-center gap-3 animate-scale-in">
                        <div onclick="switchType(true)" id="player-tab" class="flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white cursor-pointer transition-colors">
                            Player
                        </div>
                        <div onclick="switchType(false)" id="team-tab" class="flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white cursor-pointer transition-colors">
                            Team
                        </div>
                    </div>
                </div>
                
                <div class="pt-8 px-4 animate-slide-in-right">
                    
                    <!-- Player Setup Section -->
                    <div id="player-section">
                        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl p-6 mb-6 transition-colors duration-300">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Players</h3>
                                <span id="player-count" class="text-sm font-medium text-gray-500 dark:text-gray-400">0/20</span>
                            </div>
                            <!-- Dynamic List -->
                            <div id="player-list" class="space-y-3"></div>
                            
                            <button onclick="addPlayer()" id="add-player-btn" class="w-full mt-4 py-3 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-xl text-gray-500 dark:text-gray-400 font-bold flex items-center justify-center gap-2 hover:border-purple-500 hover:text-purple-500 dark:hover:border-purple-400 dark:hover:text-purple-400 transition-colors disabled:opacity-50">
                                <i data-lucide="plus" class="w-5 h-5"></i> Add Player
                            </button>
                        </div>
                        <button onclick="startGame()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-black text-xl shadow-lg shadow-purple-500/30 flex items-center justify-center gap-2 transition-all hover:scale-[1.02] active:scale-[0.98]">
                            <i data-lucide="play" class="w-6 h-6 fill-current"></i> START GAME
                        </button>
                    </div>

                    <!-- Team Setup Section -->
                    <div id="team-section" class="hidden">
                        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl p-6 mb-6 transition-colors duration-300">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Teams</h3>
                                <span id="team-count" class="text-sm font-medium text-gray-500 dark:text-gray-400">0/20</span>
                            </div>
                            <!-- Dynamic List -->
                            <div id="team-list" class="space-y-3"></div>
                            
                            <button onclick="addTeam()" id="add-team-btn" class="w-full mt-4 py-3 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-xl text-gray-500 dark:text-gray-400 font-bold flex items-center justify-center gap-2 hover:border-purple-500 hover:text-purple-500 dark:hover:border-purple-400 dark:hover:text-purple-400 transition-colors disabled:opacity-50">
                                <i data-lucide="plus" class="w-5 h-5"></i> Add Team
                            </button>
                        </div>
                        <button onclick="startGame()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-black text-xl shadow-lg shadow-purple-500/30 flex items-center justify-center gap-2 transition-all hover:scale-[1.02] active:scale-[0.98]">
                            <i data-lucide="play" class="w-6 h-6 fill-current"></i> START GAME
                        </button>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Template for list items to avoid innerHTML string building -->
    <template id="participant-row-template">
        <div class="flex items-center gap-3 animate-fade-in participant-row">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm flex-shrink-0 participant-color-box">
                <!-- Icon inserted via JS -->
            </div>
            <input type="text" class="flex-1 bg-gray-50 dark:bg-slate-700 border-2 border-transparent focus:border-purple-500 dark:focus:border-purple-400 rounded-xl px-4 py-2 outline-none font-medium text-gray-800 dark:text-white transition-colors participant-name-input" placeholder="Name">
            <button class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition-colors remove-btn">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
    </template>

    <script src="shared.js"></script>
    <script>
        let gameMode = '501';
        let isPlayerType = true;

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return params.get('mode') || '501';
        }

        function switchType(type) {
            isPlayerType = type;
            const state = getState();
            state.isPlayerType = isPlayerType;
            saveState(state);
            db.saveParticipants();
            updateUIState();
        }

        function updateUIState() {
            const playerTab = document.getElementById('player-tab');
            const teamTab = document.getElementById('team-tab');
            const playerSection = document.getElementById('player-section');
            const teamSection = document.getElementById('team-section');

            if (isPlayerType) {
                playerTab.className = 'flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white bg-red-500 dark:bg-red-500 cursor-default';
                teamTab.className = 'flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white cursor-pointer';
                playerSection.classList.remove('hidden');
                teamSection.classList.add('hidden');
                renderList(true);
            } else {
                playerTab.className = 'flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white cursor-pointer';
                teamTab.className = 'flex-1 text-center rounded-xl px-2 py-1 text-dark dark:text-white bg-green-500 dark:bg-green-500 cursor-default';
                playerSection.classList.add('hidden');
                teamSection.classList.remove('hidden');
                renderList(false);
            }
        }

        // Render list using DOM manipulation (appendChild) instead of innerHTML
        function renderList(isPlayers) {
            const state = getState();
            const listContainer = document.getElementById(isPlayers ? 'player-list' : 'team-list');
            const items = isPlayers ? state.players : state.teams;
            const template = document.getElementById('participant-row-template');
            
            // Clear current list (safe DOM manipulation)
            while (listContainer.firstChild) {
                listContainer.removeChild(listContainer.firstChild);
            }

            items.forEach((item, index) => {
                const clone = template.content.cloneNode(true);
                const row = clone.querySelector('.participant-row');
                
                // Set color
                const colorBox = clone.querySelector('.participant-color-box');
                colorBox.style.backgroundColor = item.color;
                
                // Set icon
                const icon = document.createElement('i');
                icon.setAttribute('data-lucide', isPlayers ? 'user' : 'users');
                icon.className = 'w-5 h-5';
                colorBox.appendChild(icon);

                // Set input
                const input = clone.querySelector('.participant-name-input');
                input.value = item.name;
                input.oninput = (e) => updateName(item.id, e.target.value, isPlayers);
                input.placeholder = isPlayers ? "Player Name" : "Team Name";

                // Set remove button
                const removeBtn = clone.querySelector('.remove-btn');
                if (items.length <= 1) {
                    removeBtn.classList.add('hidden'); // Hide instead of not rendering
                } else {
                    removeBtn.onclick = () => removeItem(item.id, isPlayers);
                }

                listContainer.appendChild(clone);
            });

            // Update counts
            document.getElementById(isPlayers ? 'player-count' : 'team-count').textContent = `${items.length}/20`;
            
            // Update add button state
            const addBtn = document.getElementById(isPlayers ? 'add-player-btn' : 'add-team-btn');
            addBtn.disabled = items.length >= 20;

            if (window.lucide) window.lucide.createIcons();
        }

        function addPlayer() {
            const state = getState();
            if (state.players.length >= 20) return;
            const id = Math.random().toString(36).substr(2, 9);
            const color = PLAYER_COLORS[state.players.length % PLAYER_COLORS.length];
            state.players.push({ id, name: `Player ${state.players.length + 1}`, score: 0, color });
            saveState(state);
            db.saveParticipants();
            renderList(true);
        }

        function addTeam() {
            const state = getState();
            if (state.teams.length >= 20) return;
            const id = Math.random().toString(36).substr(2, 9);
            const color = TEAM_COLORS[state.teams.length % TEAM_COLORS.length];
            state.teams.push({ id, name: `Team ${state.teams.length + 1}`, score: 0, color, players: [] });
            saveState(state);
            db.saveParticipants();
            renderList(false);
        }

        function removeItem(id, isPlayers) {
            const state = getState();
            if (isPlayers) {
                if (state.players.length <= 1) return;
                state.players = state.players.filter(p => p.id !== id);
            } else {
                if (state.teams.length <= 1) return;
                state.teams = state.teams.filter(t => t.id !== id);
            }
            saveState(state);
            db.saveParticipants();
            renderList(isPlayers);
        }

        function updateName(id, name, isPlayers) {
            const state = getState();
            const list = isPlayers ? state.players : state.teams;
            const item = list.find(x => x.id === id);
            if (item) {
                item.name = name;
                saveState(state);
                db.saveParticipants();
            }
        }

        function startGame() {
            gameMode = getUrlParams();
            const state = getState();
            const participants = state.isPlayerType ? state.players : state.teams;
            
            const gameState = {
                gameMode: gameMode,
                activeParticipants: participants.map((p, i) => ({
                    ...p,
                    score: gameMode === '501' ? 501 : gameMode === 'Killer' ? INITIAL_LIVES : 0,
                    cricketState: gameMode === 'Cricket' ? { 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 25: 0 } : undefined,
                    killerTarget: gameMode === 'Killer' ? i + 1 : undefined,
                    tttClaims: [],
                })),
                currentPlayerIndex: 0,
                winner: null,
                history: [],
                roundThrows: [],
                isPlayerType: state.isPlayerType
            };
            
            saveGameState(gameState);
            state.gameMode = gameMode;
            saveState(state);
            window.location.href = 'game.html';
        }

        window.onload = async () => {
            updateTheme();
            updateSoundIcons();
            try {
                await db.init();
                await db.loadParticipants();
                const state = getState();
                isPlayerType = state.isPlayerType; // Sync local var
                updateUIState();
            } catch (e) {
                console.error('Failed to initialize DB', e);
            }
        };
    </script>
</body>

</html>
